### Подробное руководство по **ISR (Incremental Static Regeneration)** в Next.js

**Incremental Static Regeneration (ISR)** — это одна из ключевых функций Next.js, которая позволяет обновлять статически сгенерированные страницы после их создания, не требуя полной пересборки всего сайта. Это особенно полезно для сайтов с большим количеством контента, который обновляется периодически, но не требует мгновенного обновления.

---

## **Как работает ISR?**

1. **Первая загрузка**:

    - Страница генерируется статически на этапе сборки или при первом запросе (если используется `fallback: 'blocking'` или `fallback: true`).

2. **Регенерация**:

    - После истечения интервала `revalidate` (например, 10 секунд), Next.js пытается регенерировать страницу в фоновом режиме.
    - Пока страница регенерируется, пользователи продолжают видеть старую версию.

3. **Обновление**:
    - После успешной регенерации новая версия страницы становится доступной для всех пользователей.

---

## **Преимущества ISR**

1. **Производительность**:
    - Страницы загружаются быстро, так как они статически сгенерированы.
2. **Актуальность данных**:
    - Данные обновляются через заданный интервал, что позволяет поддерживать их актуальность.
3. **Масштабируемость**:
    - ISR уменьшает нагрузку на сервер, так как страницы генерируются заранее и обновляются только при необходимости.

---

## **Настройка ISR в Page Router**

ISR в Page Router настраивается с помощью функции `getStaticProps`, где вы можете указать параметр `revalidate`. Этот параметр определяет интервал времени (в секундах), через который страница будет автоматически регенерирована.

### **1. Базовый пример**

```jsx
// pages/posts/[id].js
export default function Post({post}) {
    return (
        <div>
            <h1>{post.title}</h1>
            <p>{post.body}</p>
        </div>
    )
}

export async function getStaticProps({params}) {
    // Загрузка данных для конкретного поста
    const res = await fetch(
        `https://jsonplaceholder.typicode.com/posts/${params.id}`,
    )
    const post = await res.json()

    return {
        props: {
            post,
        },
        // Регенерировать страницу каждые 10 секунд
        revalidate: 10,
    }
}

export async function getStaticPaths() {
    // Предварительно генерируем пути для первых 10 постов
    const res = await fetch('https://jsonplaceholder.typicode.com/posts')
    const posts = await res.json()

    const paths = posts.slice(0, 10).map(post => ({
        params: {id: post.id.toString()},
    }))

    return {
        paths,
        fallback: 'blocking', // Остальные посты будут генерироваться по запросу
    }
}
```

### **Объяснение:**

1. **`getStaticProps`**:

    - Загружает данные для конкретного поста.
    - Параметр `revalidate: 10` указывает, что страница будет регенерирована каждые 10 секунд.

2. **`getStaticPaths`**:
    - Предварительно генерирует пути для первых 10 постов.
    - Параметр `fallback: 'blocking'` означает, что если страница не была предварительно сгенерирована, она будет создана на сервере при первом запросе.

---

### **2. Пример с динамическими данными**

Если данные на странице часто обновляются, ISR позволяет поддерживать их актуальность без необходимости полной пересборки сайта.

```jsx
// pages/news/[slug].js
export default function NewsArticle({article}) {
    return (
        <div>
            <h1>{article.title}</h1>
            <p>{article.content}</p>
        </div>
    )
}

export async function getStaticProps({params}) {
    // Загрузка данных для статьи
    const res = await fetch(`https://api.example.com/news/${params.slug}`)
    const article = await res.json()

    return {
        props: {
            article,
        },
        // Регенерировать страницу каждые 60 секунд
        revalidate: 60,
    }
}

export async function getStaticPaths() {
    // Предварительно генерируем пути для популярных статей
    const res = await fetch('https://api.example.com/popular-news')
    const articles = await res.json()

    const paths = articles.map(article => ({
        params: {slug: article.slug},
    }))

    return {
        paths,
        fallback: 'blocking', // Остальные статьи будут генерироваться по запросу
    }
}
```

---

## **Как работает ISR?**

1. **Первая загрузка**:

    - Страница генерируется статически на этапе сборки или при первом запросе (если используется `fallback: 'blocking'`).

2. **Регенерация**:

    - После истечения интервала `revalidate` (например, 10 секунд), Next.js пытается регенерировать страницу в фоновом режиме.
    - Пока страница регенерируется, пользователи продолжают видеть старую версию.

3. **Обновление**:
    - После успешной регенерации новая версия страницы становится доступной для всех пользователей.

---

## **Преимущества ISR**

1. **Производительность**:
    - Страницы загружаются быстро, так как они статически сгенерированы.
2. **Актуальность данных**:
    - Данные обновляются через заданный интервал, что позволяет поддерживать их актуальность.
3. **Масштабируемость**:
    - ISR уменьшает нагрузку на сервер, так как страницы генерируются заранее и обновляются только при необходимости.

---

## **Когда использовать ISR?**

- **Часто обновляемые данные**: Например, новости, блоги, акции.
- **Страницы с большим количеством контента**: Например, каталоги товаров, где не все страницы могут быть предварительно сгенерированы.
- **Сайты с высокой нагрузкой**: ISR позволяет уменьшить нагрузку на сервер, сохраняя при этом актуальность данных.

---

## **Ограничения ISR**

1. **Задержка обновления**:
    - Данные обновляются только через указанный интервал, поэтому они могут быть не совсем актуальными.
2. **Сложность настройки**:
    - Для сложных сценариев может потребоваться дополнительная настройка (например, использование `fallback: 'blocking'`).

---

## **Сравнение ISR в Page Router и App Router**

| **Функция**               | **Page Router**                        | **App Router**                       |
| ------------------------- | -------------------------------------- | ------------------------------------ |
| **Настройка ISR**         | Через `getStaticProps` с `revalidate`. | Через `fetch` с `next.revalidate`.   |
| **Динамические маршруты** | Используется `getStaticPaths`.         | Используется `generateStaticParams`. |
| **Гибкость**              | Ограничена структурой `pages`.         | Более гибкая структура `app`.        |
| **Поддержка**             | Доступна во всех версиях Next.js.      | Только в Next.js 13+ с App Router.   |

---

## **Итог**

ISR в Page Router — это мощный инструмент для создания высокопроизводительных и масштабируемых приложений. Он позволяет обновлять статически сгенерированные страницы без необходимости полной пересборки сайта. Если вы используете Page Router, ISR — отличный выбор для страниц, которые должны быть быстрыми, но при этом поддерживать актуальность данных.
